/* jQuery photoClip v1.9.1 | Relying on the plug-in [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,o){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],o):"object"==typeof exports?module.exports=o(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):(t.bjj=t.bjj||{},t.bjj.PhotoClip=o(t.jQuery,t.IScroll,t.Hammer,t.lrz))}(this,function(t,o,e,n){"use strict";function i(o,e){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var n=t.extend({},s,e),i=r(o,n);this.destroy=i.destroy}function r(i,r){function s(){V=!0,oo.append(this),w.call(this,J,function(){K=this.naturalWidth,N=this.naturalHeight}),w(to,function(){u()}),O.call(this,this.src)}function l(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};ro=new o(_[0],t)}function u(){po=0,fo=0,ho=0,oo.css({width:K,height:N}),S(oo,po,fo,ho),T(K,N),ro.zoom(ro.options.zoomStart),p(K,N);var t=.5*(Y-K*ro.options.zoomStart),o=.5*(Z-N*ro.options.zoomStart);ro.scrollTo(t,o)}function p(t,o){to.css({width:t,height:o}),_.append(to),ro.refresh()}function f(){var t=!!navigator.userAgent.match(/mobile/i);if(t){io=new e(to[0]),io.add(new e.Rotate);var o,n;io.on("rotatemove",function(t){uo||(o=t.rotation,o>180?o-=360:-180>o&&(o+=360),n=o>0?1:0>o?-1:0)}),io.on("rotateend",function(t){uo||Math.abs(o)>30&&(1==n?d(t.center):-1==n&&h(t.center))})}else to.on("dblclick",function(t){d({x:t.clientX,y:t.clientY})})}function d(t){m(90,t)}function h(t){m(-90,t)}function m(t,o){if(!uo){uo=!0;var e;e=o?x(to,o.x,o.y):y(to,_,.5*Y,.5*Z);var n,i,r=k(ho,e),a=r.x,s=r.y,c=0,l=0,u=0,f=0,d=ho+t;90==d||-270==d?(c=a+s,l=s-a,d>ho?(u=N-a-s,f=a-s):ho>d&&(u=N-s-(K-a),f=a+s-N),n=N,i=K):180==d||-180==d?(c=2*a,l=2*s,d>ho?(u=K-a-(N-s),f=N-(a+s)):ho>d&&(u=K-(a+s),f=N-s-(K-a)),n=K,i=N):270==d||-90==d?(c=a-s,l=a+s,d>ho?(u=a+s-K,f=K-a-(N-s)):ho>d&&(u=s-a,f=K-a-s),n=N,i=K):(0==d||360==d||-360==d)&&(c=0,l=0,d>ho?(u=a-s,f=a+s-K):ho>d&&(u=a+s-N,f=s-a),n=K,i=N),0==ho?(po=0,fo=0):90==ho||-270==ho?(po-=a+s,fo-=s-a):180==ho||-180==ho?(po-=2*a,fo-=2*s):(270==ho||-90==ho)&&(po-=a-s,fo-=a+s),po=po.toFixed(2)-0,fo=fo.toFixed(2)-0,S(oo,po,fo,ho,a,s),F(oo,po,fo,d,200,function(){uo=!1,ho=d%360,po+=c+u,fo+=l+f,po=po.toFixed(2)-0,fo=fo.toFixed(2)-0,S(oo,po,fo,ho),ro.scrollTo(ro.x-u*ro.scale,ro.y-f*ro.scale),T(n,i),ro.scale<ro.options.zoomMin&&ro.zoom(ro.options.zoomMin),p(n,i)})}}function g(){no=document.createElement("canvas")}function v(){if(!V)return void alert("亲，当前没有图片可以裁剪!");var t=y(to,_),o=ro.scale,e=no.getContext("2d");e.clearRect(0,0,no.width,no.height),e.save(),B&&Q?(no.width=B,no.height=Q,e.scale(B/Y*o,Q/Z*o)):(no.width=Y/o,no.height=Z/o),e.translate(po-t.x/o,fo-t.y/o),e.rotate(ho*Math.PI/180),e.drawImage(J[0],0,0),e.restore();var n=no.toDataURL(W,1);eo.css("background-image","url("+n+")"),X.call(J[0],n)}function b(){w($,function(){ao=$.width(),so=$.height()})}function y(t,o,e,n){e=e||0,n=n||0;var i,r;return w(t,function(){i=t.offset()}),w(o,function(){r=o.offset()}),{x:r.left-i.left+e,y:r.top-i.top+n}}function x(t,o,e){o=o||0,e=e||0;var n;return w(t,function(){n=t.offset()}),{x:o+lo.scrollLeft()-n.left,y:e+lo.scrollTop()-n.top}}function w(o,e){var n=t();t.each(o,function(o,e){for(var i,r=t(e),a=r.parents().addBack().filter(":hidden"),o=0;o<a.length&&r.is(":hidden");o++)i=a.eq(o),"none"==i.css("display")&&(n=n.add(i.show()))}),"function"==typeof e&&e.call(this),n.hide()}function k(t,o){var e=ro.scale,n={};return 0==t?(n.x=o.x/e,n.y=o.y/e):90==t||-270==t?(n.x=o.y/e,n.y=N-o.x/e):180==t||-180==t?(n.x=K-o.x/e,n.y=N-o.y/e):(270==t||-90==t)&&(n.x=K-o.y/e,n.y=o.x/e),n}function z(t,o,e,n){var i=t/e,r=o/n;return i>r?i:r}function T(t,o){ro.options.zoomMin=z(Y,Z,t,o),ro.options.zoomMax=Math.max(1,ro.options.zoomMin),ro.options.zoomStart=Math.min(ro.options.zoomMax,z(ao,so,t,o))}function j(){J&&J.length&&(J.remove(),delete J[0])}function M(o){j(),J=t("<img>").css({"user-select":"none","pointer-events":"none"}),J.on("load",s),J.attr("src",o)}function S(t,o,e,n,i,r){i=i||0,r=r||0;var a={};a[c+"transform"]="translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)",a[c+"transform-origin"]=i+"px "+r+"px",t.css(a)}function F(t,o,e,n,i,r){t.css(c+"transform"),t.css(c+"transition",c+"transform "+i+"ms"),t.one(a,function(){t.css(c+"transition",""),r.call(this)}),t.css(c+"transform","translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)")}function L(t){return"[object Array]"===Object.prototype.toString.call(t)}function q(){$=t(i).css({"user-select":"none",overflow:"hidden"}),"static"==$.css("position")&&$.css("position","relative"),_=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:Y,height:Z,"margin-left":-Y/2,"margin-top":-Z/2}).appendTo($),to=t("<div class='photo-clip-moveLayer'>").appendTo(_),oo=t("<div class='photo-clip-rotateLayer'>").appendTo(to);{var o=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo($);t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:Z,"margin-right":Y/2,"margin-top":-Z/2,"margin-bottom":-Z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":Y/2,"margin-top":-Z/2,"margin-bottom":-Z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":Z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":Z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:Y,height:Z,"margin-left":-Y/2-1,"margin-top":-Z/2-1}).appendTo(o)}eo=t(P),eo.length&&eo.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function R(){G.off("change"),G=null,io?(io.off("rotatemove"),io.off("rotateend"),io.destroy(),io=null):to.off("dblclick"),ro.destroy(),ro=null,$.empty(),$=null,_=null,to=null,oo=null,eo.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),eo=null}var C=r.size,A=r.outputSize,E=r.file,I=r.source,P=r.view,H=r.ok,W=r.outputType||"image/jpeg",D=r.loadStart,O=r.loadComplete,U=r.loadError,X=r.clipFinish;L(C)||(C=[260,260]),L(A)||(A=[0,0]);var Y=C[0]||260,Z=C[1]||260,B=Math.max(A[0],0),Q=Math.max(A[1],0);"jpg"===W?W="image/jpeg":"png"===W&&(W="image/png");var G=t(E);G.length&&(G.attr("accept","image/*"),G.on("change",function(){if(this.files.length){var t=this.files[0];if(!/image\/\w+/.test(t.type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(){n(t).then(function(t){M(t.base64)}).catch(function(t){alert("图片处理失败"),U.call(this,t)})},o.onerror=function(t){alert("图片加载失败"),U.call(this,t)},o.readAsDataURL(t),D.call(o,t)}}),G.click(function(){this.value=""})),I&&M(I);var J,K,N,V,$,_,to,oo,eo,no,io,ro,ao,so;q(),l(),f(),g();var co=t(H);co.length&&co.click(function(){v()});var lo=t(window);b(),lo.resize(b);var uo,po,fo,ho;return{destroy:R}}var a,s={size:[260,260],outputSize:[0,0],outputType:"jpg",file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}},c="";return function(){var t,o={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(o){return t?t+o:o.toLowerCase()};for(var i in o)if(void 0!==e.style[i+"TransitionProperty"]){c="-"+i.toLowerCase()+"-",t=o[i];break}a=n("TransitionEnd")}(),i});